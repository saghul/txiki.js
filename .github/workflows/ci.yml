name: CI

on: [pull_request]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    - name: Install dependencies
      run: |
        npm install
        sudo apt update
        sudo apt install -y clang-format
        clang-format --version
    - name: Run the linter
      run: npm run lint
    - name: Run the formatter
      run: clang-format -i src/*.{c,h}
    - name: Check if the tree is dirty
      run: $(exit $(git status --porcelain --untracked-files=no | head -255 | wc -l)) || (echo "Dirty git tree"; git diff; exit 1)
  codegen:
    name: Codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      - name: Install dependencies
        run: |
          npm install
          sudo apt update
          sudo apt install -y libcurl4-openssl-dev
      - name: Build it
        run: |
          make js
      - name: Check if the git repository is clean
        run: $(exit $(git status --porcelain --untracked-files=no | head -255 | wc -l)) || (echo "Dirty git tree"; git diff; exit 1)
  docs:
    name: Docs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    - name: Install dependencies
      run: npm install
    - name: Run the linter
      run: npm run api-docs
  build-linux:
    name: Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        buildType: [Debug, Release]
        compiler: [gcc, clang]
    env:
      BUILDTYPE: ${{ matrix.buildType }}
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    - name: Dependencies
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'
      run: |
        sudo apt update
        sudo apt install -y libcurl4-openssl-dev libltdl-dev
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt install -y clang
          echo "::set-env name=CC::clang"
          echo "::set-env name=CXX::clang++"
        fi
    - name: Build it
      run: make VERBOSE=1
    - name: Test it
      run: make test
    - name: Test it (advanced)
      run: make test-advanced
  build-macos:
    name: macOS
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        buildType: [Debug, Release]
        os: [macos-15, macos-15-intel]
    env:
      BUILDTYPE: ${{ matrix.buildType }}
    steps:
    - name: Install automake
      run: brew install automake autoconf libtool
    - uses: actions/checkout@v6
      with:
        submodules: true
    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    - name: Build it
      run: make VERBOSE=1
    - name: Test it
      run: make test
    - name: Test it (advanced)
      run: make test-advanced
  build-alpine:
    name: Alpine Linux
    runs-on: ubuntu-latest
    container: alpine:3.21
    strategy:
      fail-fast: false
      matrix:
        buildType: [Debug, Release]
    env:
      BUILDTYPE: ${{ matrix.buildType }}
    steps:
    - name: Prepare
      run: apk add git build-base cmake curl-dev autoconf automake libtool texinfo linux-headers libffi-dev --update-cache
    - uses: actions/checkout@v6
      with:
        submodules: true
    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    - name: Build it
      run: make VERBOSE=1 USE_EXTERNAL_FFI=ON
    - name: Test it
      run: make test
  build-windows:
    name: Windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        buildType: [Debug, Release]
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'
    - name: Install dependencies
      run: vcpkg install curl[ssl] libffi
    - name: Configure
      run: |
        cmake -B build -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DUSE_EXTERNAL_FFI=ON
    - name: Build
      run: cmake --build build --config ${{ matrix.buildType }}
    - name: Test
      run: |
        $env:PATH = "${{ github.workspace }}\build\${{ matrix.buildType }};${{ github.workspace }}\vcpkg\installed\x64-windows\bin;$env:PATH"
        if ("${{ matrix.buildType }}" -eq "Debug") { $env:TJS_TEST_TIMEOUT = "60000" }
        .\build\${{ matrix.buildType }}\tjs.exe test tests/
