#!/bin/bash
#
# Downloads the Mozilla CA certificate bundle from curl.se and converts it
# to a C header with a static const char array for embedding in the binary.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
OUTPUT="$PROJECT_DIR/src/cacert.h"

URL="https://curl.se/ca/cacert.pem"

echo "Downloading CA bundle from $URL ..."
PEM=$(curl -fsSL "$URL")

echo "Generating $OUTPUT ..."

cat > "$OUTPUT" <<'HEADER'
/* clang-format off */

/*
 * Mozilla CA certificate bundle.
 * Generated by scripts/update-ca-bundle.sh â€” do not edit manually.
 * Source: https://curl.se/ca/cacert.pem
 */

#ifndef TJS_CACERT_H
#define TJS_CACERT_H

static const char tjs_cacert_pem[] =
HEADER

# Convert PEM to C string literal (each line becomes "line\n")
echo "$PEM" | while IFS= read -r line; do
    # Escape backslashes and double quotes
    escaped=$(printf '%s' "$line" | sed 's/\\/\\\\/g; s/"/\\"/g')
    printf '    "%s\\n"\n' "$escaped" >> "$OUTPUT"
done

cat >> "$OUTPUT" <<'FOOTER'
;

#define TJS_CACERT_PEM_LEN (sizeof(tjs_cacert_pem) - 1)

#endif /* TJS_CACERT_H */
FOOTER

echo "Done. $(wc -l < "$OUTPUT" | tr -d ' ') lines written."
